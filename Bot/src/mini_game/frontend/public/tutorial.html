<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial - Shabbat Runner: Kedusha Path</title>
    <link rel="stylesheet" href="style.css?v=20250911-2">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="tutorial-body">
    <!-- TUTORIAL PAGE - CLEAN ARCHITECTURE -->
    <div id="tutorial-container">
        <!-- Navigation Header -->
        <div class="tutorial-nav-header">
            <button id="back-to-game" class="nav-btn">ğŸ® Back to Game</button>
            <h1 class="tutorial-page-title">ğŸ“– Tutorial: Shabbat Runner</h1>
        </div>

        <!-- Tutorial Screen 1 -->
        <div id="tutorial-screen-1" class="tutorial-screen active">
            <div class="tutorial-card">
                <div class="tutorial-header">
                    <div class="tutorial-progress">
                        <span class="progress-dots">
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </span>
                    </div>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-rabbi-area">
                        <div class="animated-rabbi teaching">ğŸ§™â€â™‚ï¸</div>
                    </div>
                    
                    <div class="tutorial-text">
                        <h3 class="tutorial-title">ğŸŒŸ Ğ”ĞĞ‘Ğ Ğ ĞŸĞĞ–ĞĞ›ĞĞ’ĞĞ¢Ğ¬!</h3>
                        <div class="speech-bubble">
                            <p>Ğ¨Ğ°Ğ»Ğ¾Ğ¼, Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¹! Ğ¯ Ñ€Ğ°Ğ²Ğ²Ğ¸Ğ½ Ğ”Ğ°Ğ²Ğ¸Ğ´ ğŸ§™â€â™‚ï¸<br>
                            ĞĞ±ÑƒÑ‡Ğ°Ñ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚Ñƒ ÑƒĞ¶Ğµ 40 Ğ»ĞµÑ‚ â€” Ğ²Ñ€ĞµĞ¼Ñ Ğ»ĞµÑ‚Ğ¸Ñ‚ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ Ğ»Ğ°Ğ¿ÑˆĞ¸!<br>
                            Ğ£ Ñ‚ĞµĞ±Ñ 45 ÑĞµĞºÑƒĞ½Ğ´ â€” ĞºĞ°Ğº Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ ğŸ˜„</p>
                        </div>
                    </div>
                    
                    <div class="shabbat-scene">
                        <div class="synagogue">ğŸ•</div>
                        <div class="sunset-backdrop">
                            <div class="sun">ğŸŒ…</div>
                            <div class="clouds">â˜ï¸ â˜ï¸</div>
                        </div>
                    </div>
                    
                    <div class="tutorial-footer">
                        <button id="tutorial-1-next" class="tutorial-btn">
                            <span class="btn-icon">â¡ï¸</span>
                            ĞĞĞ§ĞĞ¢Ğ¬ Ğ˜Ğ—Ğ£Ğ§Ğ•ĞĞ˜Ğ•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Screen 2 -->
        <div id="tutorial-screen-2" class="tutorial-screen hidden">
            <div class="tutorial-card">
                <div class="tutorial-header">
                    <div class="tutorial-progress">
                        <span class="progress-dots">
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </span>
                    </div>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-rabbi-area">
                        <div class="animated-rabbi explaining">ğŸ§™â€â™‚ï¸</div>
                    </div>
                    
                    <div class="tutorial-text">
                        <h3 class="tutorial-title">ğŸ•¯ï¸ Ğ§Ğ¢Ğ Ğ¢ĞĞšĞĞ• Ğ¨ĞĞ‘Ğ‘ĞĞ¢?</h3>
                        <div class="speech-bubble">
                            <p>Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚ â€” ÑÑ‚Ğ¾ ĞºĞ¾Ğ³Ğ´Ğ° Ğ´ÑƒÑˆĞ° Ğ±ĞµÑ€Ñ‘Ñ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹! ğŸ˜Š<br>
                            3000 Ğ»ĞµÑ‚ Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ Instagram, Ğ° Ñƒ Ğ½Ğ°Ñ Ğ±Ñ‹Ğ» Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğ¹ peace mode.<br>
                            ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²ÑŒ: Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞµĞ¼ÑŒÑ, Ğ²ĞºÑƒÑĞ½Ğ°Ñ ĞµĞ´Ğ° Ğ¸ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞµ ÑÑ‡Ğ°ÑÑ‚ÑŒĞµ!</p>
                        </div>
                    </div>
                    
                    <div class="shabbat-family-scene">
                        <div class="family-table">
                            <span class="family-member">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                            <span class="table-emoji">ğŸ½ï¸</span>
                            <span class="candles-glow">ğŸ•¯ï¸âœ¨ğŸ•¯ï¸</span>
                        </div>
                    </div>
                    
                    <div class="tutorial-footer">
                        <button id="tutorial-2-next" class="tutorial-btn">
                            <span class="btn-icon">â¡ï¸</span>
                            Ğ”ĞĞ›Ğ•Ğ•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Screen 3 -->
        <div id="tutorial-screen-3" class="tutorial-screen hidden">
            <div class="tutorial-card">
                <div class="tutorial-header">
                    <div class="tutorial-progress">
                        <span class="progress-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </span>
                    </div>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-rabbi-area">
                        <div class="animated-rabbi ready">ğŸ§™â€â™‚ï¸</div>
                    </div>
                    
                    <div class="tutorial-text">
                        <h3 class="tutorial-title">ğŸ“– Ğ¡Ğ˜ĞœĞ’ĞĞ›Ğ˜ĞšĞ ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢ĞĞ’</h3>
                        <div class="speech-bubble">
                            <p>Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸, Ñ‡Ñ‚Ğ¾ Ñƒ Ğ½Ğ°Ñ Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ÑÑ‚Ğ¾Ğ»Ğµ! ğŸ½ï¸<br>
                            ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ â€” Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ğ¸ Ğ¿Ğ¾ÑĞ»ÑƒÑˆĞ°Ğ¹!</p>
                        </div>
                    </div>
                    
                    <div class="interactive-table">
                        <div class="shabbat-table">
                            <div class="table-item" data-item="candles">
                                <span class="item-emoji">ğŸ•¯ï¸</span>
                                <div class="item-glow"></div>
                            </div>
                            <div class="table-item" data-item="bread">
                                <span class="item-emoji">ğŸ</span>
                                <div class="item-glow"></div>
                            </div>
                            <div class="table-item" data-item="wine">
                                <span class="item-emoji">ğŸ·</span>
                                <div class="item-glow"></div>
                            </div>
                            <div class="table-item" data-item="book">
                                <span class="item-emoji">ğŸ“–</span>
                                <div class="item-glow"></div>
                            </div>
                        </div>
                        
                        <!-- Overlay for better visibility -->
                        <div id="description-overlay" class="description-overlay hidden">
                            <div id="item-description" class="item-description">
                                <div class="description-bubble">
                                    <button id="close-description" class="close-btn" aria-label="Close" tabindex="0">âœ•</button>
                                    <h4 id="item-title"></h4>
                                    <p id="item-text"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tutorial-footer">
                        <button id="tutorial-3-next" class="tutorial-btn disabled">
                            <span class="btn-icon">â¡ï¸</span>
                            Ğ”ĞĞ›Ğ•Ğ•
                        </button>
                        <p class="tutorial-hint">ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Screen 4 -->
        <div id="tutorial-screen-4" class="tutorial-screen hidden">
            <div class="tutorial-card">
                <div class="tutorial-header">
                    <div class="tutorial-progress">
                        <span class="progress-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </span>
                    </div>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-rabbi-area">
                        <div class="animated-rabbi excited">ğŸ§™â€â™‚ï¸</div>
                    </div>
                    
                    <div class="tutorial-text">
                        <h3 class="tutorial-title">âœ… Ğ§Ğ¢Ğ Ğ¡ĞĞ‘Ğ˜Ğ ĞĞ¢Ğ¬</h3>
                        <div class="speech-bubble">
                            <p>Ğ’Ğ¾Ñ‚ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğµ ÑĞ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰Ğ° Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚Ğ°! âœ¨<br>
                            ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ»Ğ¸Ğº Ğ¿Ğ¾ Ğ½Ğ¸Ğ¼ â€” ĞºĞ°Ğº Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¾Ğµ Ğ±Ğ»Ğ°Ğ³Ğ¾ÑĞ»Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ. Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ!</p>
                        </div>
                    </div>
                    
                    <div class="good-items-demo">
                        <div class="items-grid">
                            <div class="demo-item good-bounce">ğŸ•¯ï¸</div>
                            <div class="demo-item good-bounce">ğŸ</div>
                            <div class="demo-item good-bounce">ğŸ·</div>
                            <div class="demo-item good-bounce">ğŸ“–</div>
                            <div class="demo-item good-bounce">ğŸŒŸ</div>
                            <div class="demo-item good-bounce">ğŸ’</div>
                        </div>
                        <div class="sparks-animation">âœ¨ âœ¨ âœ¨</div>
                    </div>
                    
                    <div class="tutorial-footer">
                        <button id="tutorial-4-next" class="tutorial-btn">
                            <span class="btn-icon">â¡ï¸</span>
                            Ğ”ĞĞ›Ğ•Ğ•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Screen 5 -->
        <div id="tutorial-screen-5" class="tutorial-screen hidden">
            <div class="tutorial-card">
                <div class="tutorial-header">
                    <div class="tutorial-progress">
                        <span class="progress-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                            <span class="dot"></span>
                        </span>
                    </div>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-rabbi-area">
                        <div class="animated-rabbi disappointed">ğŸ§™â€â™‚ï¸</div>
                    </div>
                    
                    <div class="tutorial-text">
                        <h3 class="tutorial-title">âŒ Ğ§Ğ•Ğ“Ğ Ğ˜Ğ—Ğ‘Ğ•Ğ“ĞĞ¢Ğ¬</h3>
                        <div class="speech-bubble">
                            <p>Ğ ÑÑ‚Ğ¸ ÑˆÑ‚ÑƒĞºĞ¸ â€” ĞºĞ°Ğº Ğ±ÑƒĞ´Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº Ğ² ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ñƒ ÑƒÑ‚Ñ€Ğ¾Ğ¼! ğŸ˜…<br>
                            ĞĞ´Ğ¸Ğ½ ĞºĞ»Ğ¸Ğº Ğ¸ Ğ¿Ñ€Ğ¾Ñ‰Ğ°Ğ¹ Ğ¿Ğ¾ĞºĞ¾Ğ¹... Ğ›ÑƒÑ‡ÑˆĞµ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸ Ğ¸Ñ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ¾Ğ¹, ĞºĞ°Ğº Ñ â€” Ğ´Ğ¸ĞµÑ‚Ñƒ.</p>
                        </div>
                    </div>
                    
                    <div class="bad-items-demo">
                        <div class="items-grid">
                            <div class="demo-item bad-shake">ğŸ“±</div>
                            <div class="demo-item bad-shake">ğŸ’»</div>
                            <div class="demo-item bad-shake">ğŸ’¡</div>
                            <div class="demo-item bad-shake">ğŸ’µ</div>
                            <div class="demo-item bad-shake">ğŸš—</div>
                            <div class="demo-item bad-shake">âš¡</div>
                        </div>
                        <div class="warning-glow"></div>
                    </div>
                    
                    <div class="tutorial-footer">
                        <button id="tutorial-5-next" class="tutorial-btn">
                            <span class="btn-icon">â¡ï¸</span>
                            Ğ”ĞĞ›Ğ•Ğ•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Screen 6 -->
        <div id="tutorial-screen-6" class="tutorial-screen hidden">
            <div class="tutorial-card">
                <div class="tutorial-header">
                    <div class="tutorial-progress">
                        <span class="progress-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot active"></span>
                        </span>
                    </div>
                </div>
                
                <div class="tutorial-content">
                    <div class="tutorial-rabbi-area">
                        <div class="animated-rabbi encouraging">ğŸ§™â€â™‚ï¸</div>
                    </div>
                    
                    <div class="tutorial-text">
                        <h3 class="tutorial-title">ğŸ¯ ĞŸĞĞŸĞ ĞĞ‘Ğ£Ğ™!</h3>
                        <div class="speech-bubble">
                            <p>ĞŸĞ¾Ğ¹Ğ¼Ğ°Ğ¹ ÑĞ²ĞµÑ‡Ğ¸, Ğ±ĞµĞ³Ğ¸ Ğ¾Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ² â€” ĞºĞ°Ğº Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¶Ğ¸Ğ·Ğ½Ğ¸! ğŸ˜„<br>
                            Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ½Ğ°ÑƒÑ‡Ğ¸Ğ»ÑÑ?</p>
                        </div>
                    </div>
                    
                    <div id="tutorial-demo-area" class="demo-game-area">
                        <canvas id="tutorial-canvas" width="300" height="200"></canvas>
                        <div class="demo-instructions">
                            <p class="demo-hint">ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹!</p>
                        </div>
                    </div>
                    
                    <div class="tutorial-footer">
                        <button id="tutorial-6-start" class="tutorial-btn tutorial-final">
                            <span class="btn-icon">ğŸš€</span>
                            ĞĞĞ§ĞĞ¢Ğ¬ Ğ˜Ğ“Ğ Ğ£
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial JavaScript -->
    <script>
        // Tutorial Page JavaScript - CLEAN ARCHITECTURE
        let currentScreen = 1;
        const totalScreens = 6;
        let currentLanguage = 'russian'; // Default language
        let userId = null;
        let username = 'unknown';

        // Get language and user data from URL parameters or Telegram WebApp
        function initializeLanguage() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            
            // Extract user data from Telegram WebApp or URL
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe?.user) {
                const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                userId = tgUser.id;
                username = tgUser.username || 'unknown';
                
                // Also get language from Telegram
                const langMapping = {
                    'en': 'english',
                    'english': 'english',
                    'ru': 'russian', 
                    'russian': 'russian',
                    'he': 'hebrew',
                    'hebrew': 'hebrew'
                };
                
                if (urlLang && langMapping[urlLang.toLowerCase()]) {
                    currentLanguage = langMapping[urlLang.toLowerCase()];
                } else if (tgUser.language_code) {
                    currentLanguage = langMapping[tgUser.language_code] || 'russian';
                }
                
                console.log('ğŸŒ Tutorial user:', userId, '@' + username, 'lang:', currentLanguage);
            } else {
                // Fallback to URL parameters
                userId = urlParams.get('user_id') || Date.now();
                username = urlParams.get('username') || 'unknown';
                currentLanguage = urlLang || 'russian';
            }
        }

        // Get localized content
        function getLocalizedContent() {
            return tutorialContent[currentLanguage] || tutorialContent.russian;
        }

        // Navigation between screens
        function showTutorialScreen(screenNumber) {
            // Hide all screens
            for (let i = 1; i <= totalScreens; i++) {
                const screen = document.getElementById(`tutorial-screen-${i}`);
                if (screen) {
                    screen.classList.add('hidden');
                    screen.classList.remove('active');
                }
            }
            
            // Show target screen
            const targetScreen = document.getElementById(`tutorial-screen-${screenNumber}`);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('active');
                currentScreen = screenNumber;
            }
            
            // Start demo if on screen 6
            if (screenNumber === 6) {
                setTimeout(startTutorialDemo, 500);
            }
        }

        // Multilingual Tutorial Content
        const tutorialContent = {
            russian: {
                titles: {
                    welcome: "ğŸŒŸ Ğ”ĞĞ‘Ğ Ğ ĞŸĞĞ–ĞĞ›ĞĞ’ĞĞ¢Ğ¬!",
                    whatIsShabbat: "ğŸ•¯ï¸ Ğ§Ğ¢Ğ Ğ¢ĞĞšĞĞ• Ğ¨ĞĞ‘Ğ‘ĞĞ¢?",
                    symbols: "ğŸ“– Ğ¡Ğ˜ĞœĞ’ĞĞ›Ğ˜ĞšĞ ĞŸĞ Ğ•Ğ”ĞœĞ•Ğ¢ĞĞ’",
                    goodItems: "âœ… Ğ§Ğ¢Ğ Ğ¡ĞĞ‘Ğ˜Ğ ĞĞ¢Ğ¬",
                    badItems: "âŒ Ğ§Ğ•Ğ“Ğ Ğ˜Ğ—Ğ‘Ğ•Ğ“ĞĞ¢Ğ¬", 
                    tryIt: "ğŸ¯ ĞŸĞĞŸĞ ĞĞ‘Ğ£Ğ™!"
                },
                texts: {
                    welcome: "Ğ¨Ğ°Ğ»Ğ¾Ğ¼, Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¹! Ğ¯ Ñ€Ğ°Ğ²Ğ²Ğ¸Ğ½ Ğ”Ğ°Ğ²Ğ¸Ğ´ ğŸ§™â€â™‚ï¸<br>ĞĞ±ÑƒÑ‡Ğ°Ñ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚Ñƒ ÑƒĞ¶Ğµ 40 Ğ»ĞµÑ‚ â€” Ğ²Ñ€ĞµĞ¼Ñ Ğ»ĞµÑ‚Ğ¸Ñ‚ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ Ğ»Ğ°Ğ¿ÑˆĞ¸!<br>Ğ£ Ñ‚ĞµĞ±Ñ 45 ÑĞµĞºÑƒĞ½Ğ´ â€” ĞºĞ°Ğº Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ ğŸ˜„",
                    whatIsShabbat: "Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚ â€” ÑÑ‚Ğ¾ ĞºĞ¾Ğ³Ğ´Ğ° Ğ´ÑƒÑˆĞ° Ğ±ĞµÑ€Ñ‘Ñ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ¾Ğ¹! ğŸ˜Š<br>3000 Ğ»ĞµÑ‚ Ğ½Ğ°Ğ·Ğ°Ğ´ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ Instagram, Ğ° Ñƒ Ğ½Ğ°Ñ Ğ±Ñ‹Ğ» Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğ¹ peace mode.<br>ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²ÑŒ: Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞµĞ¼ÑŒÑ, Ğ²ĞºÑƒÑĞ½Ğ°Ñ ĞµĞ´Ğ° Ğ¸ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞµ ÑÑ‡Ğ°ÑÑ‚ÑŒĞµ!",
                    symbols: "Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸, Ñ‡Ñ‚Ğ¾ Ñƒ Ğ½Ğ°Ñ Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ·Ğ´Ğ½Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ÑÑ‚Ğ¾Ğ»Ğµ! ğŸ½ï¸<br>ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ â€” Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ğ¸ Ğ¿Ğ¾ÑĞ»ÑƒÑˆĞ°Ğ¹!",
                    goodItems: "Ğ’Ğ¾Ñ‚ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğµ ÑĞ¾ĞºÑ€Ğ¾Ğ²Ğ¸Ñ‰Ğ° Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚Ğ°! âœ¨<br>ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ»Ğ¸Ğº Ğ¿Ğ¾ Ğ½Ğ¸Ğ¼ â€” ĞºĞ°Ğº Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¾Ğµ Ğ±Ğ»Ğ°Ğ³Ğ¾ÑĞ»Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ. Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ğ¼ÑƒĞ´Ñ€Ğ¾ÑÑ‚ÑŒ!",
                    badItems: "Ğ ÑÑ‚Ğ¸ ÑˆÑ‚ÑƒĞºĞ¸ â€” ĞºĞ°Ğº Ğ±ÑƒĞ´Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº Ğ² ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ñƒ ÑƒÑ‚Ñ€Ğ¾Ğ¼! ğŸ˜…<br>ĞĞ´Ğ¸Ğ½ ĞºĞ»Ğ¸Ğº Ğ¸ Ğ¿Ñ€Ğ¾Ñ‰Ğ°Ğ¹ Ğ¿Ğ¾ĞºĞ¾Ğ¹... Ğ›ÑƒÑ‡ÑˆĞµ Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸ Ğ¸Ñ… ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ¾Ğ¹, ĞºĞ°Ğº Ñ â€” Ğ´Ğ¸ĞµÑ‚Ñƒ.",
                    tryIt: "ĞŸĞ¾Ğ¹Ğ¼Ğ°Ğ¹ ÑĞ²ĞµÑ‡Ğ¸, Ğ±ĞµĞ³Ğ¸ Ğ¾Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ² â€” ĞºĞ°Ğº Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¶Ğ¸Ğ·Ğ½Ğ¸! ğŸ˜„<br>Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ½Ğ°ÑƒÑ‡Ğ¸Ğ»ÑÑ?"
                },
                buttons: {
                    start: "ĞĞĞ§ĞĞ¢Ğ¬ Ğ˜Ğ—Ğ£Ğ§Ğ•ĞĞ˜Ğ•",
                    next: "Ğ”ĞĞ›Ğ•Ğ•",
                    backToGame: "Ğ’ Ğ˜Ğ“Ğ Ğ£",
                    startGame: "ĞĞĞ§ĞĞ¢Ğ¬ Ğ˜Ğ“Ğ Ğ£"
                },
                items: {
                    candles: {
                        title: "ğŸ•¯ï¸ Ğ¡Ğ²ĞµÑ‡Ğ¸ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚Ğ°",
                        text: "Ğ—Ğ°Ğ¶Ğ¸Ğ³Ğ°ÑÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°ĞºĞ°Ñ‚Ğ¾Ğ¼ Ğ² Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ñƒ. Ğ¡Ğ²ĞµÑ‚ ÑĞ²ĞµÑ‡ĞµĞ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¼Ğ¸Ñ€ Ğ¸ ÑĞ²ÑÑ‚Ğ¾ÑÑ‚ÑŒ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ½Ğ¾ÑĞ¸Ñ‚ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚ Ğ² Ğ´Ğ¾Ğ¼."
                    },
                    bread: {
                        title: "ğŸ Ğ¥Ğ°Ğ»Ğ°", 
                        text: "ĞÑĞ¾Ğ±Ñ‹Ğ¹ Ğ¿Ğ»ĞµÑ‚Ñ‘Ğ½Ñ‹Ğ¹ Ñ…Ğ»ĞµĞ± Ğ´Ğ»Ñ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚Ğ°. Ğ”Ğ²Ğµ Ñ…Ğ°Ğ»Ñ‹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑÑ‚ Ğ´Ğ²Ğ¾Ğ¹Ğ½ÑƒÑ Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ñ Ğ¼Ğ°Ğ½Ğ½Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€ÑƒÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ğ»Ğ¸ ĞµĞ²Ñ€ĞµĞ¸ Ğ² Ğ¿ÑƒÑÑ‚Ñ‹Ğ½Ğµ."
                    },
                    wine: {
                        title: "ğŸ· Ğ’Ğ¸Ğ½Ğ¾ Ğ´Ğ»Ñ ĞšĞ¸Ğ´ÑƒÑˆĞ°",
                        text: "Ğ‘Ğ»Ğ°Ğ³Ğ¾ÑĞ»Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ´ Ğ²Ğ¸Ğ½Ğ¾Ğ¼ Ğ¾ÑĞ²ÑÑ‰Ğ°ĞµÑ‚ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚. ĞšĞ¸Ğ´ÑƒÑˆ â€” ÑÑ‚Ğ¾ Ğ¾ÑĞ¾Ğ±Ğ°Ñ Ğ¼Ğ¾Ğ»Ğ¸Ñ‚Ğ²Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ¾Ñ‚Ğ´ĞµĞ»ÑĞµÑ‚ ÑĞ²ÑÑ‚Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚ Ğ±ÑƒĞ´Ğ½ĞµĞ¹."
                    },
                    book: {
                        title: "ğŸ“– Ğ¡Ğ¸Ğ´ÑƒÑ€ (Ğ¼Ğ¾Ğ»Ğ¸Ñ‚Ğ²ĞµĞ½Ğ½Ğ¸Ğº)",
                        text: "Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¾ÑĞ¾Ğ±Ñ‹Ğµ Ğ¼Ğ¾Ğ»Ğ¸Ñ‚Ğ²Ñ‹ Ğ¸ Ğ¿ĞµÑĞ½Ğ¸ Ğ´Ğ»Ñ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚Ğ°. Ğ’ Ğ¨Ğ°Ğ±Ğ±Ğ°Ñ‚ Ñ‡Ğ¸Ñ‚Ğ°ÑÑ‚ Ğ¢Ğ¾Ñ€Ñƒ Ğ¸ Ğ¿Ğ¾ÑÑ‚ Ñ‚Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑĞ½Ğ¸ (Ğ·Ğ¼Ğ¸Ñ€Ğ¾Ñ‚)."
                    }
                }
            },
            english: {
                titles: {
                    welcome: "ğŸŒŸ WELCOME!",
                    whatIsShabbat: "ğŸ•¯ï¸ WHAT IS SHABBAT?",
                    symbols: "ğŸ“– ITEM SYMBOLS",
                    goodItems: "âœ… WHAT TO COLLECT",
                    badItems: "âŒ WHAT TO AVOID",
                    tryIt: "ğŸ¯ TRY IT!"
                },
                texts: {
                    welcome: "Shalom, dear friend! I'm Rabbi David ğŸ§™â€â™‚ï¸<br>Been teaching Shabbat for 40 years â€” time flies faster than noodles!<br>You have 45 seconds â€” like me at the grocery store ğŸ˜„",
                    whatIsShabbat: "Shabbat is when your soul takes a day off! ğŸ˜Š<br>3000 years ago there was no Instagram, but we had real peace mode.<br>Imagine: no notifications, just family, delicious food and true happiness!",
                    symbols: "Look what we have on our festive table! ğŸ½ï¸<br>Each item tells its own story â€” click and listen!",
                    goodItems: "Here are the real treasures of Shabbat! âœ¨<br>Every click on them is like a little blessing. Collect wisdom!",
                    badItems: "And these things are like an alarm clock on Saturday morning! ğŸ˜…<br>One click and goodbye peace... Better avoid them like I avoid diets.",
                    tryIt: "Catch candles, run from phones â€” just like real life! ğŸ˜„<br>Ready to show what you've learned?"
                },
                buttons: {
                    start: "START LEARNING",
                    next: "NEXT",
                    backToGame: "BACK TO GAME",
                    startGame: "START GAME"
                },
                items: {
                    candles: {
                        title: "ğŸ•¯ï¸ Shabbat Candles",
                        text: "Lit before sunset on Friday. The light of candles symbolizes peace and holiness that Shabbat brings to the home."
                    },
                    bread: {
                        title: "ğŸ Challah",
                        text: "Special braided bread for Shabbat. Two challahs symbolize the double portion of manna that Jews received in the desert."
                    },
                    wine: {
                        title: "ğŸ· Kiddush Wine",
                        text: "Blessing over wine sanctifies Shabbat. Kiddush is a special prayer that separates holy time from weekdays."
                    },
                    book: {
                        title: "ğŸ“– Siddur (Prayer Book)",
                        text: "Contains special prayers and songs for Shabbat. On Shabbat we read Torah and sing traditional songs (zemirot)."
                    }
                }
            },
            hebrew: {
                titles: {
                    welcome: "ğŸŒŸ ×‘×¨×•×›×™× ×”×‘××™×!",
                    whatIsShabbat: "ğŸ•¯ï¸ ××” ×–×” ×©×‘×ª?",
                    symbols: "ğŸ“– ×¡××œ×™ ×”×¤×¨×™×˜×™×",
                    goodItems: "âœ… ××” ×œ××¡×•×£",
                    badItems: "âŒ ×××” ×œ×”×™×× ×¢",
                    tryIt: "ğŸ¯ × ×¡×” ×–××ª!"
                },
                texts: {
                    welcome: "×©×œ×•×, ×—×‘×¨ ×™×§×¨! ×× ×™ ×”×¨×‘ ×“×•×“ ğŸ§™â€â™‚ï¸<br>××œ××“ ×©×‘×ª ×›×‘×¨ 40 ×©× ×” â€” ×”×–××Ÿ ×˜×¡ ××”×¨ ×™×•×ª×¨ ×××˜×¨×™×•×ª!<br>×™×© ×œ×š 45 ×©× ×™×•×ª â€” ×›××•× ×™ ×‘×¡×•×¤×¨ ğŸ˜„",
                    whatIsShabbat: "×©×‘×ª ×–×” ×›×©×”× ×©××” ×œ×•×§×—×ª ×™×•× ×—×•×¤×©! ğŸ˜Š<br>×œ×¤× ×™ 3000 ×©× ×” ×œ× ×”×™×” ××™× ×¡×˜×’×¨×, ××‘×œ ×”×™×” ×œ× ×• ××¦×‘ ×©×œ×•×•×” ×××™×ª×™.<br>×ª××¨×• ×œ×¢×¦××›×: ×‘×œ×™ ×”×ª×¨××•×ª, ×¨×§ ××©×¤×—×”, ××•×›×œ ×˜×¢×™× ×•××•×©×¨ ×××™×ª×™!",
                    symbols: "×ª×¨××• ××” ×™×© ×œ× ×• ×¢×œ ×”×©×•×œ×—×Ÿ ×”×—×’×™×’×™! ğŸ½ï¸<br>×›×œ ×¤×¨×™×˜ ××¡×¤×¨ ××ª ×”×¡×™×¤×•×¨ ×©×œ×• â€” ×œ×—×¦×• ×•×”×§×©×™×‘×•!",
                    goodItems: "×”× ×” ×”××•×¦×¨×•×ª ×”×××™×ª×™×™× ×©×œ ×©×‘×ª! âœ¨<br>×›×œ ×œ×—×™×¦×” ×¢×œ×™×”× ×–×” ×›××• ×‘×¨×›×” ×§×˜× ×”. ××¡×¤×• ×—×›××”!",
                    badItems: "×•×”×“×‘×¨×™× ×”××œ×” ×”× ×›××• ×©×¢×•×Ÿ ××¢×•×¨×¨ ×‘×‘×•×§×¨ ×©×‘×ª! ğŸ˜…<br>×œ×—×™×¦×” ××—×ª ×•×©×œ×•× ×¢×œ ×”×©×œ×•×•×”... ×¢×“×™×£ ×œ×”×ª×¨×—×§ ××”× ×›××•× ×™ ××“×™××˜×”.",
                    tryIt: "×ª×¤×¡×• × ×¨×•×ª, ×‘×¨×—×• ××˜×œ×¤×•× ×™× â€” ×‘×“×™×•×§ ×›××• ×‘×—×™×™× ×”×××™×ª×™×™×! ğŸ˜„<br>××•×›× ×™× ×œ×”×¨××•×ª ××” ×œ××“×ª×?"
                },
                buttons: {
                    start: "×”×ª×—×œ ×œ×™××•×“",
                    next: "×”×‘×",
                    backToGame: "×—×–×¨×” ×œ××©×—×§",
                    startGame: "×”×ª×—×œ ××©×—×§"
                },
                items: {
                    candles: {
                        title: "ğŸ•¯ï¸ × ×¨×•×ª ×©×‘×ª",
                        text: "× ×“×œ×§×™× ×œ×¤× ×™ ×©×§×™×¢×ª ×”×—××” ×‘×¢×¨×‘ ×©×‘×ª. ××•×¨ ×”× ×¨×•×ª ××¡××œ ×©×œ×•× ×•×§×“×•×©×” ×©×”×©×‘×ª ××‘×™××” ×œ×‘×™×ª."
                    },
                    bread: {
                        title: "ğŸ ×—×œ×”",
                        text: "×œ×—× ×§×œ×•×¢ ××™×•×—×“ ×œ×©×‘×ª. ×©×ª×™ ×”×—×œ×•×ª ××¡××œ×•×ª ××ª ×”×× ×” ×”×›×¤×•×œ×” ×©×œ ×”××Ÿ ×©×§×™×‘×œ×• ×”×™×”×•×“×™× ×‘××“×‘×¨."
                    },
                    wine: {
                        title: "ğŸ· ×™×™×Ÿ ×§×™×“×•×©",
                        text: "×‘×¨×›×” ×¢×œ ×”×™×™×Ÿ ××§×“×©×ª ××ª ×”×©×‘×ª. ×§×™×“×•×© ×”×™× ×ª×¤×™×œ×” ××™×•×—×“×ª ×”××¤×¨×™×“×” ×‘×™×Ÿ ×–××Ÿ ×§×“×•×© ×œ×™××™ ×”×—×•×œ."
                    },
                    book: {
                        title: "ğŸ“– ×¡×™×“×•×¨ (×¡×¤×¨ ×ª×¤×™×œ×”)",
                        text: "××›×™×œ ×ª×¤×™×œ×•×ª ×•×©×™×¨×™× ××™×•×—×“×™× ×œ×©×‘×ª. ×‘×©×‘×ª ×§×•×¨××™× ×‘×ª×•×¨×” ×•×©×¨×™× ×©×™×¨×™× ××¡×•×¨×ª×™×™× (×–××™×¨×•×ª)."
                    }
                }
            }
        };

        // Update all UI text based on current language
        function updateUILanguage() {
            const content = getLocalizedContent();
            
            // Update all tutorial titles and texts
            const updates = [
                { screen: 1, titleKey: 'welcome', textKey: 'welcome' },
                { screen: 2, titleKey: 'whatIsShabbat', textKey: 'whatIsShabbat' },
                { screen: 3, titleKey: 'symbols', textKey: 'symbols' },
                { screen: 4, titleKey: 'goodItems', textKey: 'goodItems' },
                { screen: 5, titleKey: 'badItems', textKey: 'badItems' },
                { screen: 6, titleKey: 'tryIt', textKey: 'tryIt' }
            ];
            
            updates.forEach(({ screen, titleKey, textKey }) => {
                const titleEl = document.querySelector(`#tutorial-screen-${screen} .tutorial-title`);
                const textEl = document.querySelector(`#tutorial-screen-${screen} .speech-bubble p`);
                
                if (titleEl && content.titles[titleKey]) {
                    titleEl.innerHTML = content.titles[titleKey];
                }
                if (textEl && content.texts[textKey]) {
                    textEl.innerHTML = content.texts[textKey];
                }
            });

            // Update button texts
            if (content.buttons) {
                // Update specific buttons by ID
                const buttonUpdates = [
                    { id: 'tutorial-1-next', icon: 'â¡ï¸', textKey: 'start' },
                    { id: 'tutorial-2-next', icon: 'â¡ï¸', textKey: 'next' },
                    { id: 'tutorial-3-next', icon: 'â¡ï¸', textKey: 'next' },
                    { id: 'tutorial-4-next', icon: 'â¡ï¸', textKey: 'next' },
                    { id: 'tutorial-5-next', icon: 'â¡ï¸', textKey: 'next' },
                    { id: 'tutorial-6-start', icon: 'ğŸ®', textKey: 'startGame' },
                    { id: 'back-to-game', icon: 'ğŸ®', textKey: 'backToGame' }
                ];

                buttonUpdates.forEach(({ id, icon, textKey }) => {
                    const btn = document.getElementById(id);
                    if (btn && content.buttons[textKey]) {
                        btn.innerHTML = `<span class="btn-icon">${icon}</span> ${content.buttons[textKey]}`;
                    }
                });
            }
        }

        // Interactive table functionality
        function setupInteractiveTable() {
            document.querySelectorAll('.table-item').forEach(item => {
                item.addEventListener('click', function() {
                    const itemType = this.dataset.item;
                    const content = getLocalizedContent();
                    const itemContent = content.items[itemType];
                    
                    if (itemContent) {
                        // Show description
                        const overlayDiv = document.getElementById('description-overlay');
                        const titleEl = document.getElementById('item-title');
                        const textEl = document.getElementById('item-text');
                        
                        titleEl.textContent = itemContent.title;
                        textEl.textContent = itemContent.text;
                        overlayDiv.classList.remove('hidden');
                        
                        // Enable next button
                        const nextBtn = document.getElementById('tutorial-3-next');
                        nextBtn.classList.remove('disabled');
                        
                        // Add selected effect
                        document.querySelectorAll('.table-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });
            });
        }

        // Tutorial demo functionality with ENHANCED VISUAL EFFECTS
        function startTutorialDemo() {
            const canvas = document.getElementById('tutorial-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let demoObjects = [];
            let demoRunning = true;
            let demoEffects = []; // Array for visual effects
            
            // Create demo objects
            setTimeout(() => {
                demoObjects.push({
                    x: 50,
                    y: 20,
                    emoji: 'ğŸ•¯ï¸',
                    speed: 1,
                    isGood: true,
                    size: 20,
                    scaleAnimation: null,
                    originalEmoji: 'ğŸ•¯ï¸'
                });
                demoObjects.push({
                    x: 150,
                    y: 40,
                    emoji: 'ğŸ“±',
                    speed: 1.2,
                    isGood: false,
                    size: 20,
                    scaleAnimation: null,
                    originalEmoji: 'ğŸ“±'
                });
            }, 500);
            
            // Enhanced demo animation loop with VISUAL EFFECTS
            function animateDemo() {
                if (!demoRunning) return;
                
                // Clear canvas
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Update and draw objects with ANIMATIONS
                demoObjects.forEach(obj => {
                    obj.y += obj.speed;
                    
                    // Handle scale animation like in main game
                    let currentScale = 1.0;
                    let currentRotation = 0;
                    
                    if (obj.scaleAnimation) {
                        const progress = 1 - (obj.scaleAnimation.timer / 300); // 300ms animation
                        
                        if (obj.scaleAnimation.direction === 1) {
                            // Good item: 1.0 â†’ 1.4 â†’ 1.0 (more dramatic for tutorial)
                            if (progress < 0.5) {
                                currentScale = 1.0 + (progress * 2) * 0.4;
                            } else {
                                currentScale = 1.4 - ((progress - 0.5) * 2) * 0.4;
                            }
                        } else {
                            // Bad item: shake and squash
                            if (progress < 0.5) {
                                currentScale = 1.0 - (progress * 2) * 0.3;
                                currentRotation = (Math.random() - 0.5) * 0.4; // More shake
                            } else {
                                currentScale = 0.7 + ((progress - 0.5) * 2) * 0.3;
                                currentRotation = (Math.random() - 0.5) * 0.2;
                            }
                        }
                        
                        obj.scaleAnimation.timer -= 16;
                        if (obj.scaleAnimation.timer <= 0) {
                            obj.scaleAnimation = null;
                            obj.emoji = obj.originalEmoji; // Reset emoji
                        }
                    }
                    
                    // Draw with glow effect for good items
                    ctx.save();
                    ctx.translate(obj.x + obj.size/2, obj.y + obj.size/2);
                    ctx.rotate(currentRotation);
                    ctx.scale(currentScale, currentScale);
                    
                    if (obj.isGood) {
                        // Golden glow for candles
                        ctx.shadowColor = '#FFD700';
                        ctx.shadowBlur = 10 * currentScale;
                        ctx.font = `${obj.size}px Arial`;
                        ctx.fillText(obj.emoji, -obj.size/2, obj.size/4);
                    } else {
                        // Red glow for forbidden items
                        ctx.shadowColor = '#FF4444';
                        ctx.shadowBlur = 8 * currentScale;
                        ctx.font = `${obj.size}px Arial`;
                        ctx.fillText(obj.emoji, -obj.size/2, obj.size/4);
                    }
                    
                    ctx.restore();
                    
                    // Reset position when off screen
                    if (obj.y > canvas.height + 20) {
                        obj.y = -20;
                        obj.emoji = obj.originalEmoji;
                        obj.scaleAnimation = null;
                    }
                });
                
                // Draw particle effects
                updateDemoEffects();
                
                requestAnimationFrame(animateDemo);
            }
            
            animateDemo();
            
            // Enhanced particle effect system for tutorial demo
            function createDemoSpark(x, y, isGood) {
                for (let i = 0; i < 8; i++) {
                    demoEffects.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 4,
                        vy: (Math.random() - 0.5) * 4,
                        life: 30,
                        maxLife: 30,
                        color: isGood ? '#FFD700' : '#FF4444',
                        size: Math.random() * 3 + 2
                    });
                }
            }
            
            function updateDemoEffects() {
                for (let i = demoEffects.length - 1; i >= 0; i--) {
                    const effect = demoEffects[i];
                    
                    effect.x += effect.vx;
                    effect.y += effect.vy;
                    effect.life--;
                    
                    const alpha = effect.life / effect.maxLife;
                    
                    ctx.save();
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = effect.color;
                    ctx.beginPath();
                    ctx.arc(effect.x, effect.y, effect.size * alpha, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                    
                    if (effect.life <= 0) {
                        demoEffects.splice(i, 1);
                    }
                }
            }
            
            // Enhanced canvas click handling with VISUAL EFFECTS
            canvas.addEventListener('click', function(e) {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                demoObjects.forEach(obj => {
                    const distance = Math.sqrt((clickX - (obj.x + obj.size/2))**2 + (clickY - (obj.y + obj.size/2))**2);
                    if (distance < 30 && !obj.scaleAnimation) { // Prevent double-clicks
                        
                        if (obj.isGood) {
                            // GOOD ITEM: Spark effect + scale animation
                            createDemoSpark(obj.x + obj.size/2, obj.y + obj.size/2, true);
                            obj.scaleAnimation = { timer: 300, direction: 1 };
                            obj.emoji = 'âœ¨'; // Change to sparkle during animation
                            
                            // Add floating "+2" text effect
                            demoEffects.push({
                                x: obj.x + obj.size/2,
                                y: obj.y,
                                vx: 0,
                                vy: -2,
                                life: 40,
                                maxLife: 40,
                                text: '+2',
                                color: '#00FF00',
                                size: 16
                            });
                            
                        } else {
                            // BAD ITEM: Blast effect + shake animation
                            createDemoSpark(obj.x + obj.size/2, obj.y + obj.size/2, false);
                            obj.scaleAnimation = { timer: 300, direction: -1 };
                            obj.emoji = 'ğŸ’¥'; // Change to explosion during animation
                            
                            // Add floating "-1" text effect
                            demoEffects.push({
                                x: obj.x + obj.size/2,
                                y: obj.y,
                                vx: 0,
                                vy: -2,
                                life: 40,
                                maxLife: 40,
                                text: '-1',
                                color: '#FF4444',
                                size: 16
                            });
                        }
                        
                        // Reset object position after a delay
                        setTimeout(() => {
                            obj.y = -20;
                        }, 300);
                    }
                });
                
                // Draw floating text in updateDemoEffects
                demoEffects.forEach(effect => {
                    if (effect.text) {
                        const alpha = effect.life / effect.maxLife;
                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.fillStyle = effect.color;
                        ctx.font = `bold ${effect.size}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.fillText(effect.text, effect.x, effect.y);
                        ctx.restore();
                    }
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation buttons
            const navButtons = [
                { id: 'tutorial-1-next', action: () => showTutorialScreen(2) },
                { id: 'tutorial-2-next', action: () => showTutorialScreen(3) },
                { id: 'tutorial-3-next', action: () => showTutorialScreen(4) },
                { id: 'tutorial-4-next', action: () => showTutorialScreen(5) },
                { id: 'tutorial-5-next', action: () => showTutorialScreen(6) },
                { id: 'tutorial-6-start', action: async () => {
                    // Calculate tutorial duration
                    const tutorialDuration = tutorialStartTime ? (Date.now() - tutorialStartTime) / 1000 : 0;
                    
                    // Send TUTORIAL_COMPLETED analytics before marking as seen
                    await sendAnalyticsEvent('TUTORIAL_COMPLETED', {
                        duration: tutorialDuration,
                        completed: true,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Mark tutorial as completed and go to game with autostart
                    localStorage.setItem('shabbat-tutorial-seen', 'true');
                    
                    // Small delay to ensure analytics is sent
                    setTimeout(() => {
                        window.location.href = '/game?autostart=true&from_tutorial=true';
                    }, 500);
                }}
            ];

            navButtons.forEach(({ id, action }) => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', action);
                }
            });

            // Back to game button - FIXED: Start game directly 
            const backButton = document.getElementById('back-to-game');
            if (backButton) {
                backButton.addEventListener('click', () => {
                    window.location.href = '/game?autostart=true'; // Add autostart parameter
                });
            }

            // Close description overlay with accessibility support
            const closeBtn = document.getElementById('close-description');
            if (closeBtn) {
                // Click handler
                closeBtn.addEventListener('click', () => {
                    const overlayDiv = document.getElementById('description-overlay');
                    overlayDiv.classList.add('hidden');
                });
                
                // Keyboard support (Enter/Space)
                closeBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const overlayDiv = document.getElementById('description-overlay');
                        overlayDiv.classList.add('hidden');
                    }
                });
            }

            // Also close on overlay click
            const overlayDiv = document.getElementById('description-overlay');
            if (overlayDiv) {
                overlayDiv.addEventListener('click', (e) => {
                    if (e.target === overlayDiv) {
                        overlayDiv.classList.add('hidden');
                    }
                });
            }
        }

        // ========== ANALYTICS FUNCTIONS ==========
        
        let tutorialStartTime = null;
        
        // Send analytics to server
        async function sendAnalyticsEvent(eventType, eventData = {}) {
            try {
                // Use globally initialized user data from Telegram WebApp
                const userData = {
                    user_id: userId || Date.now(),
                    username: username || 'unknown',
                    language: currentLanguage || 'russian'
                };
                
                const analyticsData = {
                    event_type: eventType,
                    ...userData,
                    ...eventData
                };
                
                const response = await fetch('/api/game-analytics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(analyticsData)
                });
                
                if (response.ok) {
                    console.log(`ğŸ“Š Analytics sent: ${eventType}`);
                } else {
                    console.warn(`âš ï¸ Analytics failed: ${eventType}`);
                }
            } catch (error) {
                console.warn(`âš ï¸ Analytics error: ${error.message}`);
            }
        }
        
        // Check if this is first-time tutorial
        function isFirstTimeTutorial() {
            return !localStorage.getItem('shabbat-tutorial-seen');
        }

        // Initialize tutorial page
        function initializeTutorial() {
            // Record tutorial start time
            tutorialStartTime = Date.now();
            
            // Initialize language first
            initializeLanguage();
            
            // Update UI with correct language
            updateUILanguage();
            
            // Setup event listeners and interactions
            setupEventListeners();
            setupInteractiveTable();
            
            // Show first screen
            showTutorialScreen(1);
            
            // Send TUTORIAL_STARTED analytics
            sendAnalyticsEvent('TUTORIAL_STARTED', {
                first_time: isFirstTimeTutorial(),
                timestamp: new Date().toISOString()
            });
            
            // Telegram WebApp optimizations
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
        }

        // Start when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeTutorial);
    </script>
</body>
</html>